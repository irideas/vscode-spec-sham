import{_ as s,c as a,o as l,ae as n}from"./chunks/framework.B_lm770W.js";const o=JSON.parse('{"title":"VS Code Configuration 存储与分层子系统软件设计说明书 (SDD)","description":"","frontmatter":{},"headers":[],"relativePath":"configuration-system/configuration-storage-layering-sdd.md","filePath":"configuration-system/configuration-storage-layering-sdd.md","lastUpdated":1765282498000}'),t={name:"configuration-system/configuration-storage-layering-sdd.md"};function e(h,i,k,p,r,d){return l(),a("div",null,[...i[0]||(i[0]=[n(`<h1 id="vs-code-configuration-存储与分层子系统软件设计说明书-sdd" tabindex="-1">VS Code Configuration 存储与分层子系统软件设计说明书 (SDD) <a class="header-anchor" href="#vs-code-configuration-存储与分层子系统软件设计说明书-sdd" aria-label="Permalink to &quot;VS Code Configuration 存储与分层子系统软件设计说明书 (SDD)&quot;">​</a></h1><h2 id="_1-文档背景与设计目标" tabindex="-1">1. 文档背景与设计目标 <a class="header-anchor" href="#_1-文档背景与设计目标" aria-label="Permalink to &quot;1. 文档背景与设计目标&quot;">​</a></h2><h3 id="_1-1-背景与基线" tabindex="-1">1.1 背景与基线 <a class="header-anchor" href="#_1-1-背景与基线" aria-label="Permalink to &quot;1.1 背景与基线&quot;">​</a></h3><ul><li>基线：<code>engines.vscode</code> ≥ 1.80，支持 Profile / Remote / Policy 叠加场景。</li><li>参考：VS Code 配置文档与源码（ConfigurationService/ConfigurationRegistry）、Settings Sync 与 Policy 文档；站内 /configuration-system/configuration-core-srs、/configuration-system/configuration-storage-layering-srs。</li></ul><h3 id="_1-2-设计目标" tabindex="-1">1.2 设计目标 <a class="header-anchor" href="#_1-2-设计目标" aria-label="Permalink to &quot;1.2 设计目标&quot;">​</a></h3><ul><li>提供统一的 <strong>ConfigurationModel</strong>，在任意 Context 中快速计算某 setting 的有效值及来源层；</li><li>将所有 settings 文件的路径定位、读写、解析、合并封装在本子系统内部，对上游暴露统一抽象，对下游屏蔽平台与 Remote 差异；</li><li>支持本地 / Remote / Profile / Policy 等多种组合场景，并保证行为可预测、可调试。</li></ul><h3 id="_1-3-使用者关注点-占位" tabindex="-1">1.3 使用者关注点（占位） <a class="header-anchor" href="#_1-3-使用者关注点-占位" aria-label="Permalink to &quot;1.3 使用者关注点（占位）&quot;">​</a></h3><ul><li>平台/核心工程：关注层叠合并正确性、事件与访问层一致性、Remote/Policy 挂接。</li><li>扩展作者/集成：关注 API 读取结果一致、写入路径与 scope 匹配。</li><li>QA/运维：关注损坏恢复、Remote/Policy/多根场景的可靠性与可观测性。</li></ul><h3 id="_1-4-约束与原则" tabindex="-1">1.4 约束与原则 <a class="header-anchor" href="#_1-4-约束与原则" aria-label="Permalink to &quot;1.4 约束与原则&quot;">​</a></h3><ul><li>必须符合 VS Code 官方语义：User / Remote / Workspace / Folder / Language-specific 的优先级与行为；</li><li>必须与 Configuration 声明子系统约定的数据结构兼容（如默认值、Schema 信息）；</li><li>必须向 Configuration 访问与变更子系统提供稳定的内部接口，避免因内部实现调整影响对外 API；</li><li>对 Remote provider 的历史实现差异，应在“默认合并规则 + 特例 hook”的模式下兼容，不改变规范层优先级约束。</li></ul><hr><h2 id="_2-架构概览" tabindex="-1">2. 架构概览 <a class="header-anchor" href="#_2-架构概览" aria-label="Permalink to &quot;2. 架构概览&quot;">​</a></h2><h3 id="_2-1-核心组件" tabindex="-1">2.1 核心组件 <a class="header-anchor" href="#_2-1-核心组件" aria-label="Permalink to &quot;2.1 核心组件&quot;">​</a></h3><ol><li><p><strong>SettingsFileLocator</strong></p><ul><li><p>负责计算各类配置文件路径与资源位置：</p><ul><li>Default settings 资源；</li><li>本地 User settings 文件；</li><li>Profile 目录下 User settings 文件；</li><li>Workspace / Folder settings 文件；</li><li>Remote user/workspace settings 访问入口（URI 或远程通道标识）。</li></ul></li></ul></li><li><p><strong>ConfigurationFileService</strong></p><ul><li><p>封装底层文件 I/O 与 Remote 通道访问：</p><ul><li>读写本地/远程 settings 文件；</li><li>监听文件系统变更；</li><li>提供统一的异步接口；</li></ul></li><li><p>对 Settings Sync 系统等外部系统也作为写入通道（通过内部接口）。</p></li></ul></li><li><p><strong>SettingsParser</strong></p><ul><li><p>负责 JSON/JSONC 内容解析，支持：</p><ul><li>注释与尾逗号；</li><li><code>&quot;[languageId]&quot;</code> block 分离；</li><li>记录错误位置信息；</li></ul></li><li><p>解析失败返回错误结构而非抛出异常。</p></li></ul></li><li><p><strong>ConfigurationLayerModel</strong></p><ul><li><p>表示某一层（例如单个 settings 文件或策略快照）的抽象模型：</p><ul><li>普通键值树；</li><li>languageId → 覆盖模型映射；</li><li>源文件路径与范围信息。</li></ul></li></ul></li><li><p><strong>ConfigurationMerger</strong></p><ul><li>将多层 <code>ConfigurationLayerModel</code> 按 SRS 的优先级进行合并；</li><li>支持对象深度合并 / 数组替换等策略；</li><li>支持按 Context（workspaceId/folderId/languageId/profileId/remoteKind/policyDomain）选择参与合并的层集合；</li><li>为特定 setting 提供可选的自定义合并策略扩展点。</li></ul></li><li><p><strong>ConfigurationModel</strong></p><ul><li><p>聚合所有层集合（Default, User, RemoteUser, Workspace, RemoteWorkspace, Folder, Policy）；</p></li><li><p>提供：</p><ul><li><code>getEffectiveValue(settingId, context)</code>；</li><li><code>inspect(settingId, context)</code> 等查询方法；</li></ul></li><li><p>内部可维护缓存以提升查询性能。</p></li></ul></li><li><p><strong>ConfigurationChangeDetector</strong></p><ul><li>负责监听文件变更与 Remote/Policy 变更事件；</li><li>调用 SettingsParser 重新解析；</li><li>触发模型更新；</li><li>生成变更 diff 信息并通知上游。</li></ul></li><li><p><strong>PolicyOverlayAdapter</strong></p><ul><li>从 Enterprise Policy 系统获取策略配置；</li><li>转换为 <code>ConfigurationLayerModel</code> 注入 Policy 层；</li><li>支持按 policyDomain 切分多个策略空间。</li></ul></li><li><p><strong>ProfileAdapter</strong></p><ul><li>接收 Profile 系统的 Profile 切换事件；</li><li>基于 SettingsFileLocator 重新定位 Profile User settings 路径；</li><li>触发 User 层重建。</li></ul></li><li><p><strong>RemoteConfigurationAdapter</strong></p><ul><li>抽象 Remote 环境配置访问；</li><li>屏蔽具体远程协议（SSH / 容器 / WSL 等），向 ConfigurationModel 提供 Remote User / Remote Workspace 层模型。</li></ul></li><li><p><strong>Diagnostics &amp; Telemetry 组件</strong></p><ul><li>接收解析错误、不可达文件、策略覆盖信息；</li><li>向日志与遥测系统输出结构化事件。</li></ul></li></ol><h3 id="_2-2-组件关系" tabindex="-1">2.2 组件关系 <a class="header-anchor" href="#_2-2-组件关系" aria-label="Permalink to &quot;2.2 组件关系&quot;">​</a></h3><ul><li>SettingsFileLocator / ConfigurationFileService：负责“知道文件在哪、如何读取/写入”；</li><li>SettingsParser：负责“把文本变成层模型”；</li><li>ConfigurationLayerModel / ConfigurationMerger / ConfigurationModel：负责“在给定上下文下提供正确的配置视图”；</li><li>ConfigurationChangeDetector / ProfileAdapter / RemoteConfigurationAdapter / PolicyOverlayAdapter：负责“感知变更并更新模型”；</li><li>Diagnostics &amp; Telemetry：负责“可观测性”。</li></ul><hr><h2 id="_3-数据结构设计" tabindex="-1">3. 数据结构设计 <a class="header-anchor" href="#_3-数据结构设计" aria-label="Permalink to &quot;3. 数据结构设计&quot;">​</a></h2><h3 id="_3-1-单层模型与配置节点" tabindex="-1">3.1 单层模型与配置节点 <a class="header-anchor" href="#_3-1-单层模型与配置节点" aria-label="Permalink to &quot;3.1 单层模型与配置节点&quot;">​</a></h3><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SourceRange</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  startLine</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  startColumn</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  endLine</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  endColumn</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SourceInfo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  filePath</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  range</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SourceRange</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  profileId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  endpointId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;     </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 远程端点标识</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  policyDomain</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ConfigNode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;                         </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 标量或数组</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  children</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ConfigNode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 对象子节点</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  source</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SourceInfo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ConfigurationLayerModel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  root</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ConfigNode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;                    </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 非 language-specific 配置树</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  languageOverrides</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ConfigNode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// languageId -&gt; ConfigNode 树</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_3-2-layerset-与-configurationmodel" tabindex="-1">3.2 LayerSet 与 ConfigurationModel <a class="header-anchor" href="#_3-2-layerset-与-configurationmodel" aria-label="Permalink to &quot;3.2 LayerSet 与 ConfigurationModel&quot;">​</a></h3><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LayerSet</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  defaultLayer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ConfigurationLayerModel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  userLayer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ConfigurationLayerModel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  remoteUserLayer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ConfigurationLayerModel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  workspaceLayer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ConfigurationLayerModel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  remoteWorkspaceLayer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ConfigurationLayerModel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  folderLayers</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ConfigurationLayerModel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// folderId -&gt; layer</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  policyLayer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ConfigurationLayerModel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ConfigurationContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  workspaceId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  folderId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  resourceUri</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  languageId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  profileId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  remoteKind</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;none&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;ssh&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;wsl&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;container&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  policyDomain</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> InspectResult</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  defaultValue</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  userValue</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  remoteUserValue</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  workspaceValue</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  remoteWorkspaceValue</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  folderValue</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  languageDefaultValue</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  languageUserValue</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  languageRemoteUserValue</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  languageWorkspaceValue</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  languageFolderValue</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  policyValue</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ConfigurationModel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  layers</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LayerSet</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  getEffectiveValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">settingId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">context</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ConfigurationContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  inspect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">settingId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">context</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ConfigurationContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> InspectResult</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_3-3-变更描述结构" tabindex="-1">3.3 变更描述结构 <a class="header-anchor" href="#_3-3-变更描述结构" aria-label="Permalink to &quot;3.3 变更描述结构&quot;">​</a></h3><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ConfigurationChange</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  affectedKeys</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[];  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 受影响的 settingId 列表</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  affectedLayers</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Array</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;default&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;user&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;remoteUser&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;workspace&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;remoteWorkspace&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;folder&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;policy&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &gt;;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  workspaceId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  folderId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  profileId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  remoteKind</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  policyDomain</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><hr><h2 id="_4-核心流程设计" tabindex="-1">4. 核心流程设计 <a class="header-anchor" href="#_4-核心流程设计" aria-label="Permalink to &quot;4. 核心流程设计&quot;">​</a></h2><h3 id="_4-1-启动时构建配置模型" tabindex="-1">4.1 启动时构建配置模型 <a class="header-anchor" href="#_4-1-启动时构建配置模型" aria-label="Permalink to &quot;4.1 启动时构建配置模型&quot;">​</a></h3><ol><li><p><strong>路径定位</strong></p><ul><li><p>SettingsFileLocator 计算：</p><ul><li>default settings 资源位置；</li><li>本地 User settings 路径；</li><li>当前 Profile 的 User settings 路径（如有）；</li><li>当前 Workspace 的 <code>.vscode/settings.json</code> 或 <code>.code-workspace</code>；</li><li>multi-root 各 folder 的 <code>.vscode/settings.json</code>；</li><li>若 Remote 已连接，远程 user/workspace settings 访问入口。</li></ul></li></ul></li><li><p><strong>解析各层</strong></p><ul><li><p>ConfigurationFileService 读取每个文件内容；</p></li><li><p>SettingsParser 解析为 <code>ConfigurationLayerModel</code>：</p><ul><li>若解析成功，缓存结果；</li><li>若解析失败，记录错误并尝试使用上一次有效模型。</li></ul></li></ul></li><li><p><strong>构建 LayerSet</strong></p><ul><li><p>将解析结果装配为 LayerSet：</p><ul><li>defaultLayer 必须存在；</li><li>userLayer、workspaceLayer、folderLayers、remoteUserLayer、remoteWorkspaceLayer、policyLayer 根据实际情况可选存在。</li></ul></li></ul></li><li><p><strong>构造 ConfigurationModel</strong></p><ul><li>使用 LayerSet 创建 ConfigurationModel 实例；</li><li>将该模型注册到 Configuration 访问与变更子系统，以便其实现对外 API。</li></ul></li></ol><h3 id="_4-2-有效值计算-geteffectivevalue" tabindex="-1">4.2 有效值计算 <code>getEffectiveValue</code> <a class="header-anchor" href="#_4-2-有效值计算-geteffectivevalue" aria-label="Permalink to &quot;4.2 有效值计算 \`getEffectiveValue\`&quot;">​</a></h3><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getEffectiveValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">settingId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">context</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ConfigurationContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">layers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> langId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> context.languageId;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 1. 非 language-specific 值（按优先级顺序）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> defaultVal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> readFromNode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(layers.defaultLayer.root, settingId);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> userVal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> layers.userLayer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> readFromNode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(layers.userLayer.root, settingId);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> remoteUserVal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> layers.remoteUserLayer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> readFromNode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(layers.remoteUserLayer.root, settingId);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> workspaceVal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> layers.workspaceLayer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> readFromNode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(layers.workspaceLayer.root, settingId);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> remoteWorkspaceVal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> layers.remoteWorkspaceLayer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> readFromNode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(layers.remoteWorkspaceLayer.root, settingId);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> folderLayer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> context.folderId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> layers.folderLayers.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(context.folderId);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> folderVal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> folderLayer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> readFromNode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(folderLayer.root, settingId);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 2. language-specific</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> langDefaultVal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> langId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> readFromLang</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(layers.defaultLayer, langId, settingId);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> langUserVal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> langId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> layers.userLayer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> readFromLang</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(layers.userLayer, langId, settingId);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> langRemoteUserVal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> langId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> layers.remoteUserLayer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> readFromLang</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(layers.remoteUserLayer, langId, settingId);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> langWorkspaceVal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> langId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> layers.workspaceLayer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> readFromLang</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(layers.workspaceLayer, langId, settingId);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> langRemoteWorkspaceVal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> langId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> layers.remoteWorkspaceLayer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> readFromLang</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(layers.remoteWorkspaceLayer, langId, settingId);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> langFolderVal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> langId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> folderLayer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> readFromLang</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(folderLayer, langId, settingId);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 3. 按优先级合并</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> defaultVal;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> merge</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(result, userVal);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> merge</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(result, remoteUserVal);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> merge</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(result, workspaceVal);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> merge</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(result, remoteWorkspaceVal);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> merge</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(result, folderVal);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> merge</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(result, langDefaultVal);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> merge</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(result, langUserVal);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> merge</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(result, langRemoteUserVal);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> merge</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(result, langWorkspaceVal);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> merge</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(result, langRemoteWorkspaceVal);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> merge</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(result, langFolderVal);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 4. Policy 覆盖</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> policyVal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> layers.policyLayer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> readFromNode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(layers.policyLayer.root, settingId);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> merge</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(result, policyVal);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><ul><li><p><code>merge(a, b)</code>：</p><ul><li>b 为 <code>undefined</code> 时返回 a；</li><li>否则根据“标量覆盖 / 对象深合并 / 数组替换”的策略进行合并；</li><li>对特殊 setting，可根据 Schema 中的自定义 merge 策略执行特例。</li></ul></li></ul><h3 id="_4-3-inspect-实现" tabindex="-1">4.3 <code>inspect</code> 实现 <a class="header-anchor" href="#_4-3-inspect-实现" aria-label="Permalink to &quot;4.3 \`inspect\` 实现&quot;">​</a></h3><p><code>inspect(settingId, context)</code> 在内部复用 <code>getEffectiveValue</code> 的读取逻辑，但不进行最终合并，而是将各层读到的值填入 <code>InspectResult</code> 对应字段，并附加源信息（如文件路径、Profile/Remote 标识）。</p><p>该接口为 Settings UI 与诊断工具提供数据。</p><h3 id="_4-4-文件变更处理流程" tabindex="-1">4.4 文件变更处理流程 <a class="header-anchor" href="#_4-4-文件变更处理流程" aria-label="Permalink to &quot;4.4 文件变更处理流程&quot;">​</a></h3><p>以 User settings 文件变更为例：</p><ol><li><p>ConfigurationFileService 接收到文件变更通知（文件系统 watcher 或 Remote 通道事件）；</p></li><li><p>调用 SettingsParser 重新解析文件内容：</p><ul><li>成功：得到新的 <code>ConfigurationLayerModel</code>；</li><li>失败：保留旧模型，记录错误。</li></ul></li><li><p>更新 LayerSet 中的 <code>userLayer</code>；</p></li><li><p>使用 ConfigurationMerger 对受影响的 setting 进行增量合并，或重建全局模型；</p></li><li><p>生成 <code>ConfigurationChange</code> 对象并通知上游；</p></li><li><p>访问与变更子系统据此触发对外事件。</p></li></ol><p>Workspace / Folder / Remote settings 文件变更流程类似，只是更新的层不同。</p><h3 id="_4-5-profile-切换流程" tabindex="-1">4.5 Profile 切换流程 <a class="header-anchor" href="#_4-5-profile-切换流程" aria-label="Permalink to &quot;4.5 Profile 切换流程&quot;">​</a></h3><ol><li>ProfileAdapter 接收到当前 ProfileId 变化事件；</li><li>SettingsFileLocator 基于新的 ProfileId 定位 Profile User settings 路径；</li><li>ConfigurationFileService 读取并通过 SettingsParser 解析为新的 <code>userLayer</code>；</li><li>更新 LayerSet.userLayer；</li><li>重建或增量更新 ConfigurationModel；</li><li>通过 ConfigurationChangeDetector 触发“全局配置变更”事件。</li></ol><h3 id="_4-6-remote-连接-断开流程" tabindex="-1">4.6 Remote 连接 / 断开流程 <a class="header-anchor" href="#_4-6-remote-连接-断开流程" aria-label="Permalink to &quot;4.6 Remote 连接 / 断开流程&quot;">​</a></h3><p><strong>连接建立：</strong></p><ol><li>RemoteConfigurationAdapter 通知远程环境可用；</li><li>通过远程通道读取 remote user/workspace settings，并解析为对应 layer；</li><li>填充 LayerSet.remoteUserLayer / remoteWorkspaceLayer；</li><li>重建模型，生成包含 Remote 层加入的 <code>ConfigurationChange</code> 并通知上游。</li></ol><p><strong>连接断开：</strong></p><ol><li>RemoteConfigurationAdapter 标记远程配置不可用；</li><li>从 LayerSet 中移除 remote 相关层；</li><li>重建模型（仅本地层有效）；</li><li>通知上游 Remote 层失效的配置变更。</li></ol><h3 id="_4-7-policy-更新流程" tabindex="-1">4.7 Policy 更新流程 <a class="header-anchor" href="#_4-7-policy-更新流程" aria-label="Permalink to &quot;4.7 Policy 更新流程&quot;">​</a></h3><ol><li>PolicyOverlayAdapter 接收到新策略配置；</li><li>将策略配置转换为 <code>ConfigurationLayerModel</code>；</li><li>替换 LayerSet.policyLayer；</li><li>重建或增量更新 ConfigurationModel；</li><li>生成仅包含 Policy 层变更的 <code>ConfigurationChange</code>，交由上游处理。</li></ol><hr><h2 id="_5-对其他子系统-系统的接口" tabindex="-1">5. 对其他子系统 / 系统的接口 <a class="header-anchor" href="#_5-对其他子系统-系统的接口" aria-label="Permalink to &quot;5. 对其他子系统 / 系统的接口&quot;">​</a></h2><h3 id="_5-1-对-configuration-访问与变更子系统" tabindex="-1">5.1 对 Configuration 访问与变更子系统 <a class="header-anchor" href="#_5-1-对-configuration-访问与变更子系统" aria-label="Permalink to &quot;5.1 对 Configuration 访问与变更子系统&quot;">​</a></h3><p>内部接口示意：</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IConfigurationStorageService</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  getValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">key</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">context</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ConfigurationContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> T</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> undefined</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  inspect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">key</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">context</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ConfigurationContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> InspectResult</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  updateValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    key</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    target</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;user&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;workspace&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;folder&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;remoteUser&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;remoteWorkspace&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    context</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ConfigurationContext</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  )</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  onDidChangeConfiguration</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">listener</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ConfigurationChange</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Disposable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><ul><li><p><code>updateValue</code>：</p><ul><li>调用 ConfigurationFileService 对对应 settings 文件执行写入；</li><li>写入成功后通过文件变更流程触发解析与模型更新；</li><li>Settings Sync 系统一样应通过该接口或等价层进行写入。</li></ul></li></ul><h3 id="_5-2-对-settings-ui-子系统" tabindex="-1">5.2 对 Settings UI 子系统 <a class="header-anchor" href="#_5-2-对-settings-ui-子系统" aria-label="Permalink to &quot;5.2 对 Settings UI 子系统&quot;">​</a></h3><ul><li><p>提供用于 UI 的附加信息接口，例如：</p><ul><li>当前 Workspace 中各层文件存在情况；</li><li>某配置项在各层的值与来源文件路径；</li><li><code>@modified</code> 所需的“是否与 Default 相同”“是否被 Policy 覆盖”等标记。</li></ul></li></ul><h3 id="_5-3-对-settings-sync-系统" tabindex="-1">5.3 对 Settings Sync 系统 <a class="header-anchor" href="#_5-3-对-settings-sync-系统" aria-label="Permalink to &quot;5.3 对 Settings Sync 系统&quot;">​</a></h3><ul><li>提供文件访问或逻辑访问接口，用于读取/写入 User settings 文件，例如：</li></ul><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ISyncAwareStorage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  readUserSettings</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">profileId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;     </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 返回 raw JSON 文本</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  writeUserSettings</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">rawJson</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">profileId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><ul><li>Settings Sync 系统不直接操作文件系统，而是通过 ConfigurationFileService 或 IConfigurationStorageService 与本子系统交互，避免模型与文件状态不一致。</li></ul><h3 id="_5-4-对-enterprise-policy-系统" tabindex="-1">5.4 对 Enterprise Policy 系统 <a class="header-anchor" href="#_5-4-对-enterprise-policy-系统" aria-label="Permalink to &quot;5.4 对 Enterprise Policy 系统&quot;">​</a></h3><ul><li>提供 Policy 覆盖注入接口，例如：</li></ul><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IPolicyConfigurationSink</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  setPolicyConfiguration</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">policyDomain</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">config</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Record</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><ul><li>Policy 系统将策略配置按域推送到本接口；</li><li>本子系统负责将其映射为 Policy 层模型并参与合并。</li></ul><hr><h2 id="_6-错误处理与容错策略" tabindex="-1">6. 错误处理与容错策略 <a class="header-anchor" href="#_6-错误处理与容错策略" aria-label="Permalink to &quot;6. 错误处理与容错策略&quot;">​</a></h2><h3 id="_6-1-json-解析容错" tabindex="-1">6.1 JSON 解析容错 <a class="header-anchor" href="#_6-1-json-解析容错" aria-label="Permalink to &quot;6.1 JSON 解析容错&quot;">​</a></h3><ul><li><p>SettingsParser 在解析失败时：</p><ul><li>不抛出未捕获异常；</li><li>返回包含错误列表的结果供日志与诊断使用；</li><li>调用方根据情况保留旧模型或清空该层。</li></ul></li></ul><h3 id="_6-2-写入失败处理" tabindex="-1">6.2 写入失败处理 <a class="header-anchor" href="#_6-2-写入失败处理" aria-label="Permalink to &quot;6.2 写入失败处理&quot;">​</a></h3><ul><li><p>ConfigurationFileService 在写入失败（权限问题、磁盘故障等）时：</p><ul><li>不修改内存中的模型（仍保持旧配置）；</li><li>返回错误信息给调用者，以便 UI 提示用户；</li><li>记录日志，供后续排查。</li></ul></li></ul><h3 id="_6-3-policy-与本地值冲突" tabindex="-1">6.3 Policy 与本地值冲突 <a class="header-anchor" href="#_6-3-policy-与本地值冲突" aria-label="Permalink to &quot;6.3 Policy 与本地值冲突&quot;">​</a></h3><ul><li><p>当 Policy 层为某设置提供值，而其他层存在不同值时：</p><ul><li>有效值采用 Policy 值；</li><li><code>inspect()</code> 必须能同时展示 Policy 与各层本地值，便于诊断。</li></ul></li></ul><hr><h2 id="_7-性能与缓存设计" tabindex="-1">7. 性能与缓存设计 <a class="header-anchor" href="#_7-性能与缓存设计" aria-label="Permalink to &quot;7. 性能与缓存设计&quot;">​</a></h2><h3 id="_7-1-查询缓存" tabindex="-1">7.1 查询缓存 <a class="header-anchor" href="#_7-1-查询缓存" aria-label="Permalink to &quot;7.1 查询缓存&quot;">​</a></h3><ul><li><p>对高频查询（如当前 active editor 的配置）可进行：</p><ul><li>上下文级别缓存（Context → 部分配置视图）；</li><li>在配置变更时仅失效与变更 keys 相关的缓存。</li></ul></li></ul><h3 id="_7-2-增量更新策略" tabindex="-1">7.2 增量更新策略 <a class="header-anchor" href="#_7-2-增量更新策略" aria-label="Permalink to &quot;7.2 增量更新策略&quot;">​</a></h3><ul><li><p>在文件小范围改动时，可以对 <code>ConfigurationLayerModel</code> 做增量更新，而非完全重建：</p><ul><li>通过 diff 计算受影响的 key；</li><li>仅对相关树节点做替换。</li></ul></li></ul><h3 id="_7-3-多-workspace-多-remote-场景优化" tabindex="-1">7.3 多 workspace / 多 remote 场景优化 <a class="header-anchor" href="#_7-3-多-workspace-多-remote-场景优化" aria-label="Permalink to &quot;7.3 多 workspace / 多 remote 场景优化&quot;">​</a></h3><ul><li>对未打开的 workspace folder 可惰性启动 watcher；</li><li>Remote 断开时及时释放远程 watcher；</li><li>在多远程端点场景中，可按 endpointId 分片缓存 Remote 层模型。</li></ul><hr><h2 id="_8-扩展性与演进-含观测与测试建议" tabindex="-1">8. 扩展性与演进（含观测与测试建议） <a class="header-anchor" href="#_8-扩展性与演进-含观测与测试建议" aria-label="Permalink to &quot;8. 扩展性与演进（含观测与测试建议）&quot;">​</a></h2><h3 id="_8-1-新层类型扩展" tabindex="-1">8.1 新层类型扩展 <a class="header-anchor" href="#_8-1-新层类型扩展" aria-label="Permalink to &quot;8.1 新层类型扩展&quot;">​</a></h3><ul><li><p>若未来引入新的配置层（如“租户层”“环境层”等），可通过：</p><ul><li>在 LayerSet 中增加对应字段；</li><li>在 ConfigurationMerger 中增加合并位置；</li><li>在 SRS 中补充优先级规则；</li><li>不破坏现有对外接口。</li></ul></li></ul><h3 id="_8-2-多租户-多环境场景" tabindex="-1">8.2 多租户 / 多环境场景 <a class="header-anchor" href="#_8-2-多租户-多环境场景" aria-label="Permalink to &quot;8.2 多租户 / 多环境场景&quot;">​</a></h3><ul><li>在多租户平台中，可在 ConfigurationContext 中增加 tenantId、environmentId，并在 ConfigurationModel 中按 tenant/environment 分片管理 LayerSet；</li><li>现有设计通过 Context 已支持增加更多维度，不需要更改接口形态。</li></ul><h3 id="_8-3-可观测性" tabindex="-1">8.3 可观测性 <a class="header-anchor" href="#_8-3-可观测性" aria-label="Permalink to &quot;8.3 可观测性&quot;">​</a></h3><ul><li>提供调试/诊断命令导出当前 LayerSet 概览（层是否可用、文件路径、最后更新时间、Policy 域）。</li><li><code>getEffectiveValue/inspect</code> 可在调试模式下输出命中层与源文件路径。</li><li>日志记录：解析错误、写入失败、Remote 通道异常、Policy 覆盖事件、合并耗时。</li></ul><h3 id="_8-4-测试建议" tabindex="-1">8.4 测试建议 <a class="header-anchor" href="#_8-4-测试建议" aria-label="Permalink to &quot;8.4 测试建议&quot;">​</a></h3><ul><li>单元：合并规则（标量/对象/数组）、语言覆盖、Policy 覆盖、Remote/Profile 层优先级。</li><li>集成：文件变更触发模型刷新与 ConfigurationChange；Profile 切换、Remote 连接/断开、Policy 更新；多根 workspace 下的 Folder/Workspace/Remote 层更新。</li><li>性能基准：大规模设置与多 folder 场景下 <code>getEffectiveValue</code>/<code>inspect</code> 延迟，增量更新耗时。</li></ul>`,89)])])}const E=s(t,[["render",e]]);export{o as __pageData,E as default};
