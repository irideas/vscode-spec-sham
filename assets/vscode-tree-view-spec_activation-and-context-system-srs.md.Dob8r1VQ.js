import{_ as i,c as a,o as e,ae as t}from"./chunks/framework.BQlYxExx.js";const E=JSON.parse('{"title":"Activation Events / Context Keys / When Clauses 需求规格说明书 (SRS)","description":"","frontmatter":{},"headers":[],"relativePath":"vscode-tree-view-spec/activation-and-context-system-srs.md","filePath":"vscode-tree-view-spec/activation-and-context-system-srs.md","lastUpdated":1764931976000}'),n={name:"vscode-tree-view-spec/activation-and-context-system-srs.md"};function l(h,s,k,p,o,d){return e(),a("div",null,[...s[0]||(s[0]=[t(`<h1 id="activation-events-context-keys-when-clauses-需求规格说明书-srs" tabindex="-1">Activation Events / Context Keys / When Clauses 需求规格说明书 (SRS) <a class="header-anchor" href="#activation-events-context-keys-when-clauses-需求规格说明书-srs" aria-label="Permalink to &quot;Activation Events / Context Keys / When Clauses 需求规格说明书 (SRS)&quot;">​</a></h1><h2 id="_1-引言" tabindex="-1">1. 引言 <a class="header-anchor" href="#_1-引言" aria-label="Permalink to &quot;1. 引言&quot;">​</a></h2><h3 id="_1-1-文档目的" tabindex="-1">1.1 文档目的 <a class="header-anchor" href="#_1-1-文档目的" aria-label="Permalink to &quot;1.1 文档目的&quot;">​</a></h3><p>明确 VS Code 激活事件、上下文键与 when clause 体系在 Tree View 场景中的需求，保证扩展仅在必要时激活，且菜单/快捷键的可见性与 Tree View 状态保持一致。</p><h3 id="_1-2-范围" tabindex="-1">1.2 范围 <a class="header-anchor" href="#_1-2-范围" aria-label="Permalink to &quot;1.2 范围&quot;">​</a></h3><ul><li><code>activationEvents</code>（<code>onView:&lt;id&gt;</code>、<code>onCommand:&lt;id&gt;</code>、<code>onUri</code>、<code>workspaceContains</code> 等）与 Tree View 的关系；</li><li>上下文键（如 <code>view == &lt;id&gt;</code>、<code>viewItem == &lt;context&gt;</code>、扩展自定义键）生命周期；</li><li><code>vscode.commands.executeCommand(&#39;setContext&#39;, ...)</code>、<code>when</code> 语法与栈式求值规则。</li></ul><h3 id="_1-3-与-tree-view-的关系概述" tabindex="-1">1.3 与 Tree View 的关系概述 <a class="header-anchor" href="#_1-3-与-tree-view-的关系概述" aria-label="Permalink to &quot;1.3 与 Tree View 的关系概述&quot;">​</a></h3><p>Tree View 依赖 <code>onView</code> 事件延迟激活，<code>TreeItem.contextValue</code> 结合上下文键控制菜单，<code>TreeView.selection</code> 变化时需要更新自定义上下文（如“是否多选”）。因此，上下文系统是 Tree View 命令和配置展示的根基。</p><h2 id="_2-引用" tabindex="-1">2. 引用 <a class="header-anchor" href="#_2-引用" aria-label="Permalink to &quot;2. 引用&quot;">​</a></h2><ul><li>VS Code 官方文档：《Activation Events》《Context Keys and When Clauses》；</li><li>API 参考：<code>commands.registerCommand</code>、<code>TreeView.onDidChangeSelection</code>、<code>setContext</code> 命令。</li></ul><h2 id="_3-总体描述" tabindex="-1">3. 总体描述 <a class="header-anchor" href="#_3-总体描述" aria-label="Permalink to &quot;3. 总体描述&quot;">​</a></h2><h3 id="_3-1-激活事件模型" tabindex="-1">3.1 激活事件模型 <a class="header-anchor" href="#_3-1-激活事件模型" aria-label="Permalink to &quot;3.1 激活事件模型&quot;">​</a></h3><ul><li>当某个条件满足（如打开视图、执行命令、接收 URI）时，VS Code 激活扩展；</li><li><code>onView:&lt;id&gt;</code> 在 Tree View 首次可见或 reveal 时触发，适合延迟加载 Provider；</li><li><code>onCommand:&lt;id&gt;</code> 用于确保命令在执行前已注册；</li><li>扩展可声明多个激活事件，VS Code 采用逻辑 OR。</li></ul><h3 id="_3-2-上下文键生命周期" tabindex="-1">3.2 上下文键生命周期 <a class="header-anchor" href="#_3-2-上下文键生命周期" aria-label="Permalink to &quot;3.2 上下文键生命周期&quot;">​</a></h3><ul><li>Workbench维护大量内建键（<code>view</code>, <code>focusedView</code>, <code>resourceScheme</code>）；</li><li>扩展可通过 <code>setContext</code> 创建/更新自定义键，作用域为当前 VS Code 实例；</li><li>当 Tree View 隐藏或节点变化时，上下文键需及时更新以避免显示错误菜单；</li><li>TreeItem 的 <code>contextValue</code> 在 <code>getTreeItem</code> 时确定，不可动态更改（需刷新节点）。</li></ul><h3 id="_3-3-when-clause-解析" tabindex="-1">3.3 When Clause 解析 <a class="header-anchor" href="#_3-3-when-clause-解析" aria-label="Permalink to &quot;3.3 When Clause 解析&quot;">​</a></h3><ul><li><code>when</code> 支持 <code>&amp;&amp;</code>, <code>||</code>, <code>!</code> 表达式，按优先级计算；</li><li>若 <code>when</code> 为空，则菜单/快捷键默认始终可用；</li><li>当相关上下文键变动时，Workbench 自动重新计算 <code>when</code>，无需扩展手动刷新；</li><li>当 <code>when</code> 解析结果为 <code>false</code> 时，菜单项隐藏或快捷键失效。</li></ul><h3 id="_3-4-tree-view-协同流程" tabindex="-1">3.4 Tree View 协同流程 <a class="header-anchor" href="#_3-4-tree-view-协同流程" aria-label="Permalink to &quot;3.4 Tree View 协同流程&quot;">​</a></h3><ol><li>声明激活事件与必需命令，保证 Tree View 延迟加载；</li><li>视图激活后注册 Provider/命令，并通过 <code>setContext</code> 初始化状态；</li><li>Tree View selection/visibility/checkbox 事件驱动上下文键更新；</li><li>菜单与快捷键根据上下文键实时评估 <code>when</code>，命令执行后可再次刷新上下文或配置；</li><li>URI Handler、配置与命令面板都应沿用同一上下文体系，确保多入口一致。</li></ol><h2 id="_4-功能需求" tabindex="-1">4. 功能需求 <a class="header-anchor" href="#_4-功能需求" aria-label="Permalink to &quot;4. 功能需求&quot;">​</a></h2><h3 id="_4-1-视图驱动的激活" tabindex="-1">4.1 视图驱动的激活 <a class="header-anchor" href="#_4-1-视图驱动的激活" aria-label="Permalink to &quot;4.1 视图驱动的激活&quot;">​</a></h3><ul><li>每个自定义 Tree View 应声明 <code>onView:&lt;id&gt;</code> 以确保延迟激活；</li><li>若视图依赖命令执行后才展示数据，需额外声明 <code>onCommand:&lt;command&gt;</code>；</li><li><code>onUri</code> 用于 Tree View + Deep Link 场景，需结合 URI Handler。</li></ul><h3 id="_4-2-上下文键管理" tabindex="-1">4.2 上下文键管理 <a class="header-anchor" href="#_4-2-上下文键管理" aria-label="Permalink to &quot;4.2 上下文键管理&quot;">​</a></h3><ul><li>扩展必须在 Tree View selection/过滤状态变化时更新上下文键；</li><li>自定义键命名建议 <code>&lt;ext&gt;.context.flag</code>，避免与内建键冲突；</li><li><code>setContext</code> 调用应在扩展激活后执行，不可在 <code>package.json</code> 声明；</li><li>键值类型可为 boolean/string/number，<code>when</code> 中使用 <code>==</code> 或直接引用。</li></ul><h3 id="_4-3-treeitem-contextvalue-映射" tabindex="-1">4.3 TreeItem contextValue 映射 <a class="header-anchor" href="#_4-3-treeitem-contextvalue-映射" aria-label="Permalink to &quot;4.3 TreeItem contextValue 映射&quot;">​</a></h3><ul><li><code>TreeItem.contextValue</code> 与 <code>viewItem == ...</code> 搭配使用；</li><li>若一个节点需要多个上下文，可将 <code>contextValue</code> 设为 <code>&quot;nodeA;critical&quot;</code> 并在 when 中使用 <code>viewItem =~ /critical/</code>（或使用多个 contextValue via custom logic — 需 VS Code 1.74+）；</li><li>修改 <code>contextValue</code> 必须通过刷新节点重新返回 TreeItem。</li></ul><h3 id="_4-4-调试与质量门槛" tabindex="-1">4.4 调试与质量门槛 <a class="header-anchor" href="#_4-4-调试与质量门槛" aria-label="Permalink to &quot;4.4 调试与质量门槛&quot;">​</a></h3><ul><li>扩展应在开发模式下提供 “Inspect Context Keys” 快捷入口或命令日志；</li><li>高频 <code>setContext</code> 调用需做节流，避免导致菜单频繁重算；</li><li>当上下文依赖远端状态（如登录）时，失效后需重置为默认值以免保留脏状态；</li><li>QA 回归应覆盖“激活→上下文→命令→上下文刷新”闭环，确保无死锁或 race。</li></ul><h2 id="_5-tree-view-用例" tabindex="-1">5. Tree View 用例 <a class="header-anchor" href="#_5-tree-view-用例" aria-label="Permalink to &quot;5. Tree View 用例&quot;">​</a></h2><h3 id="_5-1-延迟激活的依赖树" tabindex="-1">5.1 延迟激活的依赖树 <a class="header-anchor" href="#_5-1-延迟激活的依赖树" aria-label="Permalink to &quot;5.1 延迟激活的依赖树&quot;">​</a></h3><p><strong>场景</strong>：依赖树仅在用户展开视图时加载，避免启动时浪费资源。</p><p><strong>流程</strong>：</p><ol><li>Manifest 声明 <code>activationEvents: [&quot;onView:dependencyAudit&quot;]</code>；</li><li>用户第一次点击视图标签，VS Code 激活扩展；</li><li>扩展注册 Provider 并立刻触发初次刷新；</li><li>其他命令在扩展未激活前不可用。</li></ol><p><strong>Manifest</strong>：</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;activationEvents&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;onView:dependencyAudit&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;contributes&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;views&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;explorer&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [ { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;dependencyAudit&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;name&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Dependency Audit&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } ] }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>TypeScript</strong>：</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> activate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ctx</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> vscode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ExtensionContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> provider</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> DependencyAuditProvider</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  vscode.window.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">registerTreeDataProvider</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;dependencyAudit&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, provider);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_5-2-动态上下文-多选时启用批量命令" tabindex="-1">5.2 动态上下文：多选时启用批量命令 <a class="header-anchor" href="#_5-2-动态上下文-多选时启用批量命令" aria-label="Permalink to &quot;5.2 动态上下文：多选时启用批量命令&quot;">​</a></h3><p><strong>场景</strong>：在 Tree View 中选中多个节点时，需要显示“批量删除”命令，并在命令面板/快捷键中使用 <code>when</code> 控制。</p><p><strong>流程</strong>：</p><ol><li>Tree View 开启 <code>canSelectMany</code>；</li><li><code>onDidChangeSelection</code> 根据 selection 长度调用 <code>setContext(&#39;dep.multiselect&#39;, true/false)</code>；</li><li><code>view/title</code> 菜单 <code>when: view == dependencyAudit &amp;&amp; dep.multiselect</code>；</li><li>命令实现读取 <code>treeView.selection</code> 执行批量操作。</li></ol><p><strong>TypeScript</strong>：</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> treeView</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vscode.window.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createTreeView</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;dependencyAudit&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, { treeDataProvider: provider, canSelectMany: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">treeView.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">onDidChangeSelection</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  vscode.commands.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">executeCommand</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;setContext&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;dep.multiselect&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, e.selection.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><p><strong>Manifest</strong>：</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;contributes&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;menus&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;view/title&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;command&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;dependencyAudit.bulkDelete&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;when&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;view == dependencyAudit &amp;&amp; dep.multiselect&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;group&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;navigation@4&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;commands&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [ { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;command&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;dependencyAudit.bulkDelete&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;title&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;批量删除依赖&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_5-3-状态过滤-上下文键与-treeitem-contextvalue-联动" tabindex="-1">5.3 状态过滤：上下文键与 TreeItem.contextValue 联动 <a class="header-anchor" href="#_5-3-状态过滤-上下文键与-treeitem-contextvalue-联动" aria-label="Permalink to &quot;5.3 状态过滤：上下文键与 TreeItem.contextValue 联动&quot;">​</a></h3><p><strong>场景</strong>：TODO Tree View 允许用户选择“仅显示未完成”状态，菜单项和 TreeItem contextValue 需同步更新。</p><p><strong>流程</strong>：</p><ol><li><code>setContext(&#39;todos.showOpenOnly&#39;, true/false)</code> 控制过滤开关；</li><li><code>view/title</code> 菜单 <code>when: todos.showOpenOnly</code> 显示“显示全部”；</li><li>TreeItem <code>contextValue</code> 根据 <code>done</code> 状态设置 <code>todo.done/todo.open</code>；</li><li>当过滤状态变化时，Provider 触发 refresh；菜单 <code>when</code> 自动重新评估。</li></ol><p><strong>TypeScript</strong>：</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> toggleFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> current</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vscode.workspace.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getConfiguration</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;todos&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;showOpenOnly&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> next</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">current;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vscode.workspace.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getConfiguration</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;todos&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;showOpenOnly&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, next, vscode.ConfigurationTarget.Global);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vscode.commands.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">executeCommand</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;setContext&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;todos.showOpenOnly&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, next);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  provider.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">refresh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>Manifest</strong>：</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;contributes&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;menus&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;view/title&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;command&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;todos.toggleFilter&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;when&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;view == teamTodos &amp;&amp; todos.showOpenOnly&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;group&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;navigation@5&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;command&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;todos.toggleFilter&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;when&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;view == teamTodos &amp;&amp; !todos.showOpenOnly&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;group&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;navigation@5&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;commands&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [ { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;command&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;todos.toggleFilter&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;title&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;切换开放任务过滤&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_5-4-uri-激活-onuri-setcontext-打开深度链接" tabindex="-1">5.4 URI 激活：onUri + setContext 打开深度链接 <a class="header-anchor" href="#_5-4-uri-激活-onuri-setcontext-打开深度链接" aria-label="Permalink to &quot;5.4 URI 激活：onUri + setContext 打开深度链接&quot;">​</a></h3><p><strong>场景</strong>：成本树支持 <code>vscode://</code> 链接，扩展需在接收到 URI 时激活，即使 Tree View 尚未打开。</p><p><strong>流程</strong>：</p><ol><li><code>activationEvents</code> 包含 <code>onUri</code>；</li><li>URI Handler 解码参数并调用 <code>setContext(&#39;costInsights.pendingReveal&#39;, nodeId)</code>；</li><li>当视图可见时，Provider 根据上下文键执行 <code>reveal</code>；</li><li>完成后清理上下文键。</li></ol><p><strong>Manifest</strong>：</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;activationEvents&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;onView:costInsights&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;onUri&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;contributes&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;commands&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [ { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;command&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;costInsights.reveal&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;title&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Reveal Cost Node&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>TypeScript</strong>：</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pendingReveal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> undefined</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">vscode.window.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">registerUriHandler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  handleUri</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">uri</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    pendingReveal </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> URLSearchParams</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(uri.query).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;nodeId&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">??</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> undefined</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    vscode.commands.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">executeCommand</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;setContext&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;costInsights.pendingReveal&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(pendingReveal));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    ensureViewVisible</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">costView.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">onDidChangeVisibility</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (e.visible </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pendingReveal) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> node</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> provider.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">resolveNodeById</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(pendingReveal);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (node) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> costView.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">reveal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(node, { focus: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    pendingReveal </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> undefined</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    vscode.commands.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">executeCommand</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;setContext&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;costInsights.pendingReveal&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><h2 id="_6-非功能需求" tabindex="-1">6. 非功能需求 <a class="header-anchor" href="#_6-非功能需求" aria-label="Permalink to &quot;6. 非功能需求&quot;">​</a></h2><ul><li><strong>性能</strong>：上下文键更新应避免高频调用，推荐在状态确实变化时更新；</li><li><strong>可靠性</strong>：<code>setContext</code> 调用失败应记录日志；</li><li><strong>安全</strong>：禁止从不可信输入直接设置上下文字段值，以防注入；</li><li><strong>可测试性</strong>：扩展应提供 <code>ContextKeyService</code> 抽象以便单元测试。</li></ul><h2 id="_7-未来演进" tabindex="-1">7. 未来演进 <a class="header-anchor" href="#_7-未来演进" aria-label="Permalink to &quot;7. 未来演进&quot;">​</a></h2><ul><li>提供类型安全的 Context Key 注册 API；</li><li>支持视图级别 <code>when</code> 调试工具，帮助开发者诊断上下文；</li><li>允许 per-resource 上下文作用域，以便 Tree View 在多工作区场景下独立控制。</li></ul>`,65)])])}const c=i(n,[["render",l]]);export{E as __pageData,c as default};
