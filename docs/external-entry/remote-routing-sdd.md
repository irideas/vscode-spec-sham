# 远程/浏览器路由 SDD（平台供给域）

提供 Remote/SSH/WSL/Tunnel/Codespaces/Web 场景下生成与消费外部入口的设计建议：重写策略、可达性检测、回退、实例路由等。消费方在各域实现具体 UI/业务。

## 1. 设计目标
- 可达性：生成的链接在目标环境可被实际点击/回调。  
- 适配性：自动适配不同 scheme/authority/端口变化。  
- 弹性：隧道变更或失效时有回退与提示。

## 2. 重写与生成策略
- 链接生成流程：内部 URI → `asExternalUri` 重写 →（可选）签名/ttl/nonce → 分发；分发时使用重写后的完整 URL。  
- 不缓存硬编码 authority/端口；如需缓存，附带有效期并在使用前重新验证。  
- 对外展示的 scheme 一律用 `vscode.env.uriScheme`，避免 Desktop/Web 差异。

## 3. 可达性与回退
- 可选健康检查：在生成/消费前以 HEAD/GET 检查重写后的 URL 是否可达（若环境允许）；不可达则提示“需开启隧道/权限”。  
- 回退策略：  
  - Remote 无法重写时，提示用户改用本地打开或手动复制内部地址；  
  - Codespaces/隧道失效时，提示重新建立隧道或刷新页面。  
- 避免在 Handler 内长时间等待网络；超时应提示并允许用户重试。

## 4. 实例与窗口路由
- 默认仅当前客户端实例收到 `onUri`；如需多实例同步，需自行广播（存储/IPC/服务端下发）。  
- 设计命令/Service 时避免依赖“唯一窗口”假设；如结果需要跨窗口显示，使用消息通道或存储。

## 5. 反模式
- 硬编码 `vscode://` 或固定端口，忽略 `asExternalUri`，导致 Remote/Web 不可用。  
- 对重写结果长期缓存、不做有效性检查，导致链接失效。  
- 在 Handler 中执行网络重试阻塞 UI；应异步并提示。

## 6. 检查清单
- [ ] 生成共享链接前调用 `asExternalUri`；分发使用重写后的 URL。  
- [ ] 使用 `uriScheme` 而非硬编码 scheme。  
- [ ] 对重写后的 URL 进行可达性提示/回退（至少提示无法重写/无隧道）。  
- [ ] 不假定多窗口路由；必要时自行广播或提示限制。  
- [ ] 高风险/敏感操作继续遵守安全 SRS（确认、脱敏、签名）。

## 7. 演进
- 提供官方重写结果的有效期/稳定性提示接口。  
- 提供多实例路由策略（选择窗口/实例）的平台支持。  
- SDK 级封装：生成、签名、重写、健康检查的一站式工具。
