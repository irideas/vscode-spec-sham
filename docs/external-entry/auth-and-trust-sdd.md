# 外部入口安全与信任 SDD（平台供给域）

提供入口安全/信任的设计建议：参数校验、签名/一次性 token、防重放、隐私与日志、破坏性操作确认，以及 Remote/Web 环境差异的处理。消费侧需结合本章方案与各自域的 UI/业务要求。

## 1. 设计目标
- 入口可验证、可追踪：参数来源可控，错误可诊断。  
- 安全默认拒绝：校验失败或来源未知时，不执行副作用。  
- 低耦合：安全校验与业务处理分层，便于复用与测试。

## 2. 参考实现模式
### 2.1 入口校验管线
1) 解析：`URL/URLSearchParams`，白名单字段，类型/长度校验。  
2) 认证：签名/HMAC 或一次性 token（含 timestamp/nonce）；检查过期、防重放（nonce 存储/窗口内缓存）。  
3) 授权：匹配允许的 action/view/command 列表，最小权限执行。  
4) 风险分级：为 destructive 操作标记高风险，强制用户确认。  
5) 调度：通过命令/Service 执行；失败统一收口提示 + 日志/遥测。

### 2.2 Token/签名建议
- 签名字段（如 `sig`）基于固定排序的参数 + 时间戳 + nonce，使用 HMAC-SHA256；服务端/生成端与扩展共享密钥。  
- 一次性 token 存储最近使用记录（内存/SecretStorage），防止短时间重复。  
- 过期时间明确（如 5–10 分钟），过期即拒绝并提示。

### 2.3 破坏性操作确认
- 明确 action 与影响对象（如 “删除资源 X”）；二次确认或需要用户输入关键字（视场景而定）。  
- 对自动执行的批量操作，提供预览/列表，并允许用户取消。  
- 在命令/Service 层防二次触发（节流/幂等）。

### 2.4 隐私与日志
- URI 中不包含凭证/个人数据；必要参数使用短期 token。  
- 日志/遥测只记录去标识化数据（action、结果码、耗时），不记录原始 query；可存哈希值用于排查。  
- 异常信息对用户友好，避免暴露内部结构。

### 2.5 Remote/Web/Codespaces 考虑
- 生成共享链接前先调用 `asExternalUri`，对重写后的 URI 再做签名/校验（签名应覆盖重写后的完整 URL）。  
- 不信任来源 IP；验证完全依赖 token/签名。  
- 若代理/隧道导致链接不可达，应提供降级提示或本地打开选项。

## 3. 反模式
- 在 Handler 中直接执行副作用，无校验/无确认。  
- 将敏感 token 直接放入 URI 或日志。  
- 忽略 nonce/ttl，导致重放攻击。  
- 依赖本地/内网 IP 作为信任依据，在 Remote/Web 环境下失效。

## 4. 检查清单
- [ ] 入口字段白名单、必填、长度/类型校验。  
- [ ] 签名/一次性 token 校验，含时间戳/nonce，具备防重放。  
- [ ] 高风险 action 强制确认，支持取消/幂等。  
- [ ] 不泄漏敏感信息到 URI/日志/提示。  
- [ ] Remote/Web 使用 `asExternalUri` 后的 URL 做签名/验证，异常有提示。  
- [ ] 错误统一提示与遥测收口。

## 5. 演进
- 提供可复用的验证/签名 SDK 与安全策略配置。  
- 引入“高风险入口”统一 UI 提示或系统级确认。  
- 多实例/多租户的 nonce/凭证隔离策略。
