# 外部入口安全与信任 SRS（平台供给域）

定义 URI/外部入口在安全、身份、信任方面的硬性事实约束。适用于所有消费方（Tree/Editor/Webview/Terminal/Debug 等），消费侧需遵守本章约束并在各自域内补充 UI/业务细节。

## 1. 范围与基线
- 基线与 [uri-and-links-srs](/external-entry/uri-and-links-srs) 一致：`engines.vscode` ≥ 1.80，覆盖 Desktop/Remote/Web/Codespaces。  
- 范围：入口参数与协议约束、认证/授权、破坏性操作确认、隐私与日志、Remote/Web 差异。  
- 非范围：具体业务权限模型、消费侧 UI 流（由各域定义）。

## 2. 威胁与假设
- 假设入口 URI 可被用户分享或被外部系统生成，存在篡改、重放、误触风险。  
- Remote/Web/Codespaces 可能经过反向代理/隧道，不能假定源 IP 可信。  
- 多窗口/多实例下，Handler 仅保证当前实例接收，不保证广播。

## 3. 安全与信任硬性要求
1) **参数与解析**：必须使用 `URL/URLSearchParams` 解析；仅接受白名单字段，校验类型/长度/必填，禁止直接拼接为 Shell/文件路径。  
2) **认证/授权**：入口如需身份，应携带签名/一次性 token 或设备码，并校验过期/重放（nonce/ttl）；缺失或校验失败必须拒绝并提示。  
3) **破坏性操作确认**：删除/覆盖/推送/执行外部副作用的入口必须在消费侧弹出明确确认对话框；无提示执行视为违规。  
4) **隐私与日志**：敏感信息（token/凭证/个人数据）不得出现在可共享 URI、提示、日志；必要日志需脱敏。  
5) **最小权限**：入口调用的命令/服务应符合最小权限原则；禁止通过入口绕过既有授权链路。  
6) **Remote/Web 差异**：对经 `asExternalUri` 重写的 URI，应同样执行上述校验；不得因运行环境不同而放宽检查。  
7) **错误反馈**: 校验失败、权限不足、资源不存在时必须向用户提示（错误/警告），不可静默丢弃。  
8) **缓存与清理**：处理完毕后应清理临时凭证/状态，避免被后续窗口复用。

## 4. 兼容性与边界
- 旧引擎或无 `asExternalUri` 的环境，入口能力可能受限；扩展需检测并提示不支持。  
- 无法确认来源可信时，默认低信任：只允许无副作用操作或要求用户确认。  
- URI Handler 不应承担持久会话管理，长生命周期凭证应交由 SecretStorage/账户系统。

## 5. 质量与实践基线（占位）
- 安全/可靠性/兼容性指标后续补充，当前请遵循上文硬性要求与 /external-entry/uri-and-links-srs 的平台约束。

## 6. 用例映射（引用）
- **UC-URI-03**（OAuth/设备登录）：必须校验签名/过期，并在写入凭据前确认账户切换风险。  
- **UC-URI-02/05/06**（分享/深链）：分享链接不得包含敏感信息；落点前必须确认高风险动作。  
- 其他消费方（Editor/Webview/Terminal/Debug）遵循同样的入口校验与确认要求。

## 7. 未来演进（非当前事实）
- 统一的入口签名/nonce SDK，或系统级“高风险入口”提示。  
- 多实例/多租户的入口路由与隔离策略。
